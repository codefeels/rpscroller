import{r as p,l as re,u as X,c as ie,m as ae,j as h,B as oe,a as le,o as ce}from"./index-Bisk0RAm.js";import{w as de,u as fe,a as ue,c as he,I as pe,b as _,i as O,s as ge,d as me,U as L,e as J,f as be,m as ye}from"./Sidebar-DhqwjClm.js";import{C as Se,L as Q,o as we,E as Fe}from"./LoadingSpinner-BiSEUkaz.js";import"./BaseDialog-B4X8y4tI.js";import"./Link-DtBKRGOo.js";import"./formatDistanceToNowStrict-BGM-HUpS.js";import"./en-US-A-7Ux56e.js";const Re=()=>{},ve=Re(),B=Object,Y=e=>e===ve,Pe=e=>typeof e=="function",M=new WeakMap,xe=e=>B.prototype.toString.call(e),U=(e,n)=>e===`[object ${n}]`;let je=0;const V=e=>{const n=typeof e,t=xe(e),l=U(t,"Date"),a=U(t,"RegExp"),r=U(t,"Object");let i,d;if(B(e)===e&&!l&&!a){if(i=M.get(e),i)return i;if(i=++je+"~",M.set(e,i),Array.isArray(e)){for(i="@",d=0;d<e.length;d++)i+=V(e[d])+",";M.set(e,i)}if(r){i="#";const F=B.keys(e).sort();for(;!Y(d=F.pop());)Y(e[d])||(i+=d+":"+V(e[d])+",");M.set(e,i)}}else i=l?e.toJSON():n=="symbol"?e.toString():n=="string"?JSON.stringify(e):""+e;return i},Ce=e=>{if(Pe(e))try{e=e()}catch{e=""}const n=e;return e=typeof e=="string"?e:(Array.isArray(e)?e.length:e)?V(e):"",[e,n]},Ee=e=>Ce(e?e(0,null):null)[0],k=Promise.resolve(),Oe=e=>(n,t,l)=>{const a=p.useRef(!1),{cache:r,initialSize:i=1,revalidateAll:d=!1,persistSize:F=!1,revalidateFirstPage:R=!0,revalidateOnMount:j=!1,parallel:w=!1}=l,[,,,s]=ue.get(he);let o;try{o=Ee(n),o&&(o=pe+o)}catch{}const[g,u,D]=_(r,o),I=p.useCallback(()=>O(g()._l)?i:g()._l,[r,o,i]);ge.useSyncExternalStore(p.useCallback(f=>o?D(o,()=>{f()}):()=>{},[r,o]),I,I);const c=p.useCallback(()=>{const f=g()._l;return O(f)?i:f},[o,i]),y=p.useRef(c());me(()=>{if(!a.current){a.current=!0;return}o&&u({_l:F?y.current:c()})},[o,r]);const $=j&&!a.current,v=e(o,async f=>{const E=g()._i,m=g()._r;u({_r:L});const P=[],z=c(),[W]=_(r,f),C=W().data,N=[];let G=null;for(let b=0;b<z;++b){const[T,A]=J(n(b,w?null:G));if(!T)break;const[ee,te]=_(r,T);let x=ee().data;const se=d||E||O(x)||R&&!b&&!O(C)||$||C&&!O(C[b])&&!l.compare(C[b],x);if(t&&(typeof m=="function"?m(x,A):se)){const H=async()=>{if(!(T in s))x=await t(A);else{const ne=s[T];delete s[T],x=await ne}te({data:x,_k:A}),P[b]=x};w?N.push(H):await H()}else P[b]=x;w||(G=x)}return w&&await Promise.all(N.map(b=>b())),u({_i:L}),P},l),S=p.useCallback(function(f,E){const m=typeof E=="boolean"?{revalidate:E}:E||{},P=m.revalidate!==!1;return o?(P&&(O(f)?u({_i:!0,_r:m.revalidate}):u({_i:!1,_r:m.revalidate})),arguments.length?v.mutate(f,{...m,revalidate:P}):v.mutate()):k},[o,r]),Z=p.useCallback(f=>{if(!o)return k;const[,E]=_(r,o);let m;if(be(f)?m=f(c()):typeof f=="number"&&(m=f),typeof m!="number")return k;E({_l:m}),y.current=m;const P=[],[z]=_(r,o);let W=null;for(let C=0;C<m;++C){const[N]=J(n(C,W)),[G]=_(r,N),b=N?G().data:L;if(O(b))return S(z().data);P.push(b),W=b}return S(P)},[o,r,S,c]);return{size:c(),setSize:Z,mutate:S,get data(){return v.data},get error(){return v.error},get isValidating(){return v.isValidating},get isLoading(){return v.isLoading}}},Ie=de(fe,Oe);function _e(e,n){let t=e;const a={totalPosts:e.length,commentTypeFiltered:0,urlTypeFiltered:0,gifFiltered:0,redGifsOnlyFiltered:0,noRedGifsFiltered:0,pinnedFiltered:0,blockedFiltered:0,remainingPosts:0},r=t.filter(s=>!("comment_type"in s));a.commentTypeFiltered=t.length-r.length,t=r;const i=t.filter(({url:s})=>s.includes("redgifs")||s.endsWith(".jpg")||s.endsWith(".webp")||s.endsWith(".jpeg")||s.endsWith(".png")||s.endsWith(".gif")||s.endsWith(".webp")||s.startsWith("https://www.reddit.com/gallery"));a.urlTypeFiltered=t.length-i.length,t=i;const d=t.filter(s=>n.noGifs?!s.url.endsWith(".gif"):!0);a.gifFiltered=t.length-d.length,t=d;const F=t.filter(s=>n.redGifsOnly?s.url.includes("redgifs"):!0);a.redGifsOnlyFiltered=t.length-F.length,t=F;const R=t.filter(s=>n.noRedGifs?!s.url.includes("redgifs"):!0);a.noRedGifsFiltered=t.length-R.length,t=R;const j=t.filter(s=>n.skipPinned?!s.pinned:!0);a.pinnedFiltered=t.length-j.length,t=j;const w=t.filter(s=>!n.blocked.includes(s.author));return a.blockedFiltered=t.length-w.length,t=w,n.dedupe&&(t=re(t,s=>s.url)),a.remainingPosts=t.length,{filteredPosts:t,stats:a}}function K({data:e,setSize:n,size:t,isValidating:l,isLoading:a}){const{noGifs:r,blocked:i,skipPinned:d,dedupe:F,noRedGifs:R,redGifsOnly:j}=X(),w=ie(),{isIntersecting:s,ref:o}=ae({threshold:w?.5:.8}),g=p.useRef(!1),u=e.flatMap(S=>S.children).map(S=>S.data),D=a||t>0&&e[t-1]===void 0,c=(e[0]?.children.length??0)===0||(e.at(-1)?.children.length??0)<25,y=l&&e.length===t;p.useEffect(()=>{s&&!g.current&&!a&&!y&&!c&&(g.current=!0,setTimeout(()=>{n(t+1).then(()=>{g.current=!1}).catch(S=>{console.error(S)})},400))},[s,n,t,c,y,a]);const{filteredPosts:$,stats:v}=_e(u,{noGifs:r,blocked:i,skipPinned:d,dedupe:F,noRedGifs:R,redGifsOnly:j});return h.jsxs("div",{children:[h.jsx(Se,{posts:$,stats:v}),h.jsx("div",{ref:o,style:{height:400},className:"flex justify-center mt-10",children:D?h.jsx(Q,{}):c?"End of feed!":h.jsxs("div",{children:["(Loaded ",u.length," posts ",v.commentTypeFiltered," of those were comments) ... Scroll all the way down or"," ",h.jsx(oe,{onClick:()=>{!g.current&&!y&&(g.current=!0,setTimeout(()=>{n(t+1).then(()=>{g.current=!1}).catch(S=>{console.error(S)})},400))},children:"Click here"})," ","to load more"]})})]})}const De=720*60*60*1e3,q=we("feedCache",1,{upgrade(e){e.createObjectStore("feeds")}});async function Ne(e){const t=await(await q).get("feeds",e);if(t)return t}async function Te(e,n){await(await q).put("feeds",{data:n,timestamp:Date.now()},e)}async function We(){const n=(await q).transaction("feeds","readwrite");let l=await n.objectStore("feeds").openCursor();for(;l;){const a=l.value;Date.now()-a.timestamp>De&&await l.delete(),l=await l.continue()}await n.done}function Ge(e){return(n,t)=>t&&!t.after?null:n===0?`${e}${e.includes("?")?"&":"?"}limit=25`:`${e}${e.includes("?")?"&":"?"}after=${t?.after}&limit=25`}const Me=async()=>{};function qe(){const e=X(),{defaultPage:n,mode:t}=e,l=le(n),a=ce.get(t)?.url,r=`https://www.reddit.com/${l.startsWith("/")?l.slice(1):l}${a??""}`,[i,d]=p.useState(),[F,R]=p.useState(!1),[j,w]=p.useState(r);j!==r&&(w(r),d(void 0),R(!1));const{data:s,size:o,setSize:g,error:u,isValidating:D,isLoading:I}=Ie(Ge(r),async c=>(await ye(c)).data,{revalidateOnFocus:!1,revalidateOnReconnect:!1,revalidateIfStale:!1,dedupingInterval:6e4,focusThrottleInterval:5e3});return p.useEffect(()=>{We().catch(c=>{console.error(c)})},[]),p.useEffect(()=>{s&&!u&&Te(r,s).catch(c=>{console.error(c)})},[s,u,r]),p.useEffect(()=>{let c=!1;return u&&!s&&Ne(r).then(y=>{!c&&y&&(d(y.data),R(!0))}).catch(y=>{console.error(y)}),()=>{c=!0}},[u,s,r]),h.jsx("div",{children:F&&i?h.jsxs(h.Fragment,{children:[h.jsx("div",{className:"bg-amber-100 border border-amber-400 text-amber-800 px-4 py-2 text-center text-sm",children:"Showing old content (Reddit API error)"}),h.jsx(K,{data:i,setSize:Me,size:i.length,isValidating:!1,isLoading:!1})]}):I?h.jsx("div",{className:"flex justify-center",children:h.jsx(Q,{})}):u?h.jsx(Fe,{error:u}):s?h.jsx(K,{data:s,setSize:g,size:o,isValidating:D,isLoading:I}):null})}export{qe as default};
//# sourceMappingURL=RedditPostFeed-BpXQfaku.js.map
