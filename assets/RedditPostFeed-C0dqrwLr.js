import{r as v,l as se,u as K,c as ne,m as re,j as m,B as ie,a as ae,o as le}from"./index-CuM5DBy1.js";import{w as oe,u as ce,a as de,c as fe,I as ue,b as _,i as C,s as he,d as pe,U as L,e as V,f as ge,m as me}from"./Sidebar-B294I6pp.js";import{C as ye,L as X,E as Fe}from"./LoadingSpinner-GrT3aIsG.js";import"./BaseDialog-BDARILpV.js";import"./Link-D6gY-XmS.js";import"./formatDistanceToNowStrict-BGM-HUpS.js";import"./en-US-A-7Ux56e.js";const Re=()=>{},Pe=Re(),B=Object,H=e=>e===Pe,be=e=>typeof e=="function",$=new WeakMap,Se=e=>B.prototype.toString.call(e),k=(e,r)=>e===`[object ${r}]`;let ve=0;const q=e=>{const r=typeof e,t=Se(e),u=k(t,"Date"),a=k(t,"RegExp"),l=k(t,"Object");let n,o;if(B(e)===e&&!u&&!a){if(n=$.get(e),n)return n;if(n=++ve+"~",$.set(e,n),Array.isArray(e)){for(n="@",o=0;o<e.length;o++)n+=q(e[o])+",";$.set(e,n)}if(l){n="#";const y=B.keys(e).sort();for(;!H(o=y.pop());)H(e[o])||(n+=o+":"+q(e[o])+",");$.set(e,n)}}else n=u?e.toJSON():r=="symbol"?e.toString():r=="string"?JSON.stringify(e):""+e;return n},je=e=>{if(be(e))try{e=e()}catch{e=""}const r=e;return e=typeof e=="string"?e:(Array.isArray(e)?e.length:e)?q(e):"",[e,r]},Ee=e=>je(e?e(0,null):null)[0],U=Promise.resolve(),we=e=>(r,t,u)=>{const a=v.useRef(!1),{cache:l,initialSize:n=1,revalidateAll:o=!1,persistSize:y=!1,revalidateFirstPage:R=!0,revalidateOnMount:j=!1,parallel:h=!1}=u,[,,,s]=de.get(fe);let i;try{i=Ee(r),i&&(i=ue+i)}catch{}const[p,E,M]=_(l,i),T=v.useCallback(()=>C(p()._l)?n:p()._l,[l,i,n]);he.useSyncExternalStore(v.useCallback(c=>i?M(i,()=>{c()}):()=>{},[l,i]),T,T);const F=v.useCallback(()=>{const c=p()._l;return C(c)?n:c},[i,n]),O=v.useRef(F());pe(()=>{if(!a.current){a.current=!0;return}i&&E({_l:y?O.current:F()})},[i,l]);const D=j&&!a.current,P=e(i,async c=>{const x=p()._i,d=p()._r;E({_r:L});const b=[],z=F(),[I]=_(l,c),w=I().data,W=[];let N=null;for(let f=0;f<z;++f){const[G,A]=V(r(f,h?null:N));if(!G)break;const[Q,Z]=_(l,G);let S=Q().data;const ee=o||x||C(S)||R&&!f&&!C(w)||D||w&&!C(w[f])&&!u.compare(w[f],S);if(t&&(typeof d=="function"?d(S,A):ee)){const J=async()=>{if(!(G in s))S=await t(A);else{const te=s[G];delete s[G],S=await te}Z({data:S,_k:A}),b[f]=S};h?W.push(J):await J()}else b[f]=S;h||(N=S)}return h&&await Promise.all(W.map(f=>f())),E({_i:L}),b},u),g=v.useCallback(function(c,x){const d=typeof x=="boolean"?{revalidate:x}:x||{},b=d.revalidate!==!1;return i?(b&&(C(c)?E({_i:!0,_r:d.revalidate}):E({_i:!1,_r:d.revalidate})),arguments.length?P.mutate(c,{...d,revalidate:b}):P.mutate()):U},[i,l]),Y=v.useCallback(c=>{if(!i)return U;const[,x]=_(l,i);let d;if(ge(c)?d=c(F()):typeof c=="number"&&(d=c),typeof d!="number")return U;x({_l:d}),O.current=d;const b=[],[z]=_(l,i);let I=null;for(let w=0;w<d;++w){const[W]=V(r(w,I)),[N]=_(l,W),f=W?N().data:L;if(C(f))return g(z().data);b.push(f),I=f}return g(b)},[i,l,g,F]);return{size:F(),setSize:Y,mutate:g,get data(){return P.data},get error(){return P.error},get isValidating(){return P.isValidating},get isLoading(){return P.isLoading}}},xe=oe(ce,we);function Ce(e,r){let t=e;const a={totalPosts:e.length,commentTypeFiltered:0,urlTypeFiltered:0,gifFiltered:0,redGifsOnlyFiltered:0,noRedGifsFiltered:0,pinnedFiltered:0,blockedFiltered:0,remainingPosts:0},l=t.filter(s=>!("comment_type"in s));a.commentTypeFiltered=t.length-l.length,t=l;const n=t.filter(({url:s})=>s.includes("redgifs")||s.endsWith(".jpg")||s.endsWith(".webp")||s.endsWith(".jpeg")||s.endsWith(".png")||s.endsWith(".gif")||s.endsWith(".webp")||s.startsWith("https://www.reddit.com/gallery"));a.urlTypeFiltered=t.length-n.length,t=n;const o=t.filter(s=>r.noGifs?!s.url.endsWith(".gif"):!0);a.gifFiltered=t.length-o.length,t=o;const y=t.filter(s=>r.redGifsOnly?s.url.includes("redgifs"):!0);a.redGifsOnlyFiltered=t.length-y.length,t=y;const R=t.filter(s=>r.noRedGifs?!s.url.includes("redgifs"):!0);a.noRedGifsFiltered=t.length-R.length,t=R;const j=t.filter(s=>r.skipPinned?!s.pinned:!0);a.pinnedFiltered=t.length-j.length,t=j;const h=t.filter(s=>!r.blocked.includes(s.author));return a.blockedFiltered=t.length-h.length,t=h,r.dedupe&&(t=se(t,s=>s.url)),a.remainingPosts=t.length,{filteredPosts:t,stats:a}}function Oe({data:e,setSize:r,size:t,isValidating:u,isLoading:a}){const{noGifs:l,blocked:n,skipPinned:o,dedupe:y,noRedGifs:R,redGifsOnly:j}=K(),h=ne(),{isIntersecting:s,ref:i}=re({threshold:h?.5:.8}),p=v.useRef(!1),E=e.flatMap(g=>g.children).map(g=>g.data),M=a||t>0&&e[t-1]===void 0,F=(e[0]?.children.length??0)===0||(e.at(-1)?.children.length??0)<25,O=u&&e.length===t;v.useEffect(()=>{s&&!p.current&&!a&&!O&&!F&&(p.current=!0,setTimeout(()=>{r(t+1).then(()=>{p.current=!1}).catch(g=>{console.error(g)})},400))},[s,r,t,F,O,a]);const{filteredPosts:D,stats:P}=Ce(E,{noGifs:l,blocked:n,skipPinned:o,dedupe:y,noRedGifs:R,redGifsOnly:j});return m.jsxs("div",{children:[m.jsx(ye,{posts:D,stats:P}),m.jsx("div",{ref:i,style:{height:400},className:"flex justify-center mt-10",children:M?m.jsx(X,{}):F?"End of feed!":m.jsxs("div",{children:["(Loaded ",E.length," posts ",P.commentTypeFiltered," of those were comments) ... Scroll all the way down or"," ",m.jsx(ie,{onClick:()=>{!p.current&&!O&&(p.current=!0,setTimeout(()=>{r(t+1).then(()=>{p.current=!1}).catch(g=>{console.error(g)})},400))},children:"Click here"})," ","to load more"]})})]})}function _e(e){return(r,t)=>t&&!t.after?null:r===0?`${e}${e.includes("?")?"&":"?"}limit=25`:`${e}${e.includes("?")?"&":"?"}after=${t?.after}&limit=25`}function ze(){const e=K(),{defaultPage:r,mode:t}=e,u=ae(r),a=le.get(t)?.url,l=`https://www.reddit.com/${u.startsWith("/")?u.slice(1):u}${a??""}`,{data:n,size:o,setSize:y,error:R,isValidating:j,isLoading:h}=xe(_e(l),async s=>(await me(s)).data);return m.jsx("div",{children:h?m.jsx("div",{className:"flex justify-center",children:m.jsx(X,{})}):R?m.jsx(Fe,{error:R}):n?m.jsx(Oe,{data:n,setSize:y,size:o,isValidating:j,isLoading:h}):null})}export{ze as default};
//# sourceMappingURL=RedditPostFeed-C0dqrwLr.js.map
